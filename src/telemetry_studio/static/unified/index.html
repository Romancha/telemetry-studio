<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoPro Dashboard Overlay</title>
    <link rel="stylesheet" href="/static/unified/css/unified.css">
</head>
<body>
    <div id="app">
        <!-- Header -->
        <header class="unified-header">
            <div class="header-left">
                <h1>GoPro Dashboard Overlay</h1>
            </div>

            <div class="header-center">
                <div id="file-context" class="file-context hidden">
                    <span class="file-context-icon"></span>
                    <div class="file-context-info">
                        <span class="file-context-name"></span>
                        <div class="file-context-details">
                            <span class="file-resolution"></span>
                            <span class="file-fps"></span>
                            <span class="file-duration"></span>
                            <span class="file-gps gps-badge"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="header-right">
                <div class="mode-toggle">
                    <button id="mode-quick" class="mode-btn active">Quick Mode</button>
                    <button id="mode-advanced" class="mode-btn">Advanced Mode</button>
                </div>
                <button id="btn-export" class="btn btn-secondary">Export XML</button>
                <button id="btn-batch-render" class="btn btn-secondary">Batch Render</button>
                <button id="btn-render" class="btn btn-primary">Render Video</button>
                <button id="btn-generate-cmd" class="btn btn-secondary">Get Command</button>
            </div>
        </header>

        <!-- Main Content -->
        <div class="unified-main">
            <!-- Left Sidebar -->
            <aside id="sidebar" class="sidebar">
                <!-- File Upload Section -->
                <div class="sidebar-section">
                    <h3>Files</h3>
                    <div id="file-uploader-container">
                        <!-- FileUploader renders here -->
                    </div>
                    <!-- GPX/FIT Options (shown when merge/gpx-only mode) -->
                    <div id="gpx-options-container"></div>
                </div>

                <!-- Quick Mode: Widget palette hidden -->
                <div id="widget-palette-container" class="sidebar-scroll">
                    <div class="sidebar-section">
                        <h3>Widgets</h3>
                        <input type="text" id="widget-search" placeholder="Search widgets..." style="margin-bottom: var(--space-3);">
                        <div id="widget-palette" class="widget-palette">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Preview Area (Center) -->
            <main class="preview-area">
                <!-- Toolbar -->
                <div class="preview-toolbar">
                    <div class="toolbar-group" id="quick-toolbar">
                        <label for="layout-select">Layout:</label>
                        <select id="layout-select"></select>
                    </div>

                    <div class="toolbar-divider"></div>

                    <div class="toolbar-group" id="advanced-toolbar" style="display: none;">
                        <button id="btn-undo" class="btn btn-icon btn-secondary" title="Undo" disabled>&#8592;</button>
                        <button id="btn-redo" class="btn btn-icon btn-secondary" title="Redo" disabled>&#8594;</button>

                        <span class="toolbar-divider"></span>

                        <button id="btn-zoom-out" class="btn btn-icon btn-secondary" title="Zoom Out">-</button>
                        <span id="zoom-level" style="min-width: 50px; text-align: center;">100%</span>
                        <button id="btn-zoom-in" class="btn btn-icon btn-secondary" title="Zoom In">+</button>
                        <button id="btn-zoom-fit" class="btn btn-icon btn-secondary" title="Fit to View">Fit</button>

                        <span class="toolbar-divider"></span>

                        <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                            <input type="checkbox" id="toggle-grid" checked>
                            Grid
                        </label>
                        <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                            <input type="checkbox" id="toggle-snap">
                            Snap
                        </label>

                        <span class="toolbar-divider"></span>

                        <label for="template-select">Template:</label>
                        <select id="template-select">
                            <option value="">-- Select Template --</option>
                        </select>

                        <button id="btn-save-template" class="btn btn-sm btn-secondary" title="Save Current Layout as Template">
                            Save
                        </button>
                        <button id="btn-upload-template" class="btn btn-sm btn-secondary" title="Upload XML Template">
                            Upload
                        </button>
                        <button id="btn-manage-templates" class="btn btn-sm btn-secondary" title="Manage My Templates">
                            Manage
                        </button>
                        <input type="file" id="template-file-input" accept=".xml" class="visually-hidden">
                    </div>

                    <div style="flex: 1;"></div>

                    <div class="toolbar-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="auto-preview" checked>
                            <span>Auto</span>
                        </label>
                        <button id="btn-refresh-preview" class="btn btn-sm btn-secondary">
                            <span class="btn-text">Refresh</span>
                            <span id="preview-spinner" class="spinner-small"></span>
                        </button>
                    </div>
                </div>

                <!-- Preview Viewport -->
                <div class="preview-viewport">
                    <!-- Empty state -->
                    <div id="preview-empty" class="preview-empty">
                        <div class="preview-empty-icon"></div>
                        <div class="preview-empty-text">No preview available</div>
                        <div class="preview-empty-hint">Upload a file and select a layout to see preview</div>
                    </div>

                    <!-- Loading state -->
                    <div id="preview-loading" class="preview-loading">
                        <div class="spinner"></div>
                        <p>Generating preview...</p>
                    </div>

                    <!-- Preview container (for Quick mode) -->
                    <div id="preview-container" class="preview-container hidden">
                        <img id="preview-image" alt="Preview">
                    </div>

                    <!-- Canvas container (for Advanced mode) -->
                    <div id="canvas-container">
                        <div id="canvas-viewport" class="canvas-viewport">
                            <!-- Spacer defines the scrollable area (absolute elements don't contribute to overflow) -->
                            <div id="canvas-spacer" class="canvas-spacer"></div>
                            <img id="canvas-preview-image" class="canvas-preview-image" alt="Preview">
                            <div id="canvas" class="canvas"></div>
                        </div>
                        <div id="canvas-empty-hint" class="canvas-empty-hint">
                            <div class="hint-icon">&#128230;</div>
                            <div class="hint-text">
                                <p><strong>Canvas is empty</strong></p>
                                <p>Drag widgets from the left panel</p>
                                <p>or select a template above</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Timeline -->
                <div id="timeline-container" class="timeline-container">
                    <div class="timeline">
                        <div class="timeline-track" id="timeline-track">
                            <div class="timeline-thumbnails" id="timeline-thumbnails">
                                <!-- Thumbnails generated by JS -->
                            </div>
                            <div class="timeline-playhead" id="timeline-playhead" style="left: 0;"></div>
                        </div>
                        <div class="timeline-controls">
                            <div>
                                <span class="timeline-time" id="timeline-current">00:00</span>
                                <span class="timeline-duration" id="timeline-duration">/ 00:00</span>
                            </div>
                            <div class="timeline-quick-btns">
                                <button class="timeline-quick-btn" data-percent="0">Start</button>
                                <button class="timeline-quick-btn" data-percent="25">25%</button>
                                <button class="timeline-quick-btn" data-percent="50">50%</button>
                                <button class="timeline-quick-btn" data-percent="75">75%</button>
                                <button class="timeline-quick-btn" data-percent="100">End</button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Right Panel -->
            <aside id="right-panel" class="right-panel">
                <div class="panel-tabs">
                    <button class="panel-tab active" data-tab="config">Config</button>
                    <button class="panel-tab" data-tab="properties">Properties</button>
                    <button class="panel-tab" data-tab="layers">Layers</button>
                </div>

                <!-- Config Tab (Quick mode) -->
                <div id="config-panel" class="panel-content">
                    <div class="config-group">
                        <label>Speed Unit</label>
                        <select id="units-speed"></select>
                    </div>
                    <div class="config-group">
                        <label>Altitude Unit</label>
                        <select id="units-altitude"></select>
                    </div>
                    <div class="config-row">
                        <div class="config-group">
                            <label>Distance</label>
                            <select id="units-distance"></select>
                        </div>
                        <div class="config-group">
                            <label>Temperature</label>
                            <select id="units-temperature"></select>
                        </div>
                    </div>
                    <div class="config-group">
                        <label>Map Style</label>
                        <select id="map-style"></select>
                    </div>
                    <div class="config-group">
                        <label>FFmpeg Profile</label>
                        <select id="ffmpeg-profile"></select>
                        <small class="config-hint" id="ffmpeg-profile-hint"></small>
                    </div>
                </div>

                <!-- Properties Tab (Advanced mode) -->
                <div id="properties-panel" class="panel-content hidden">
                    <div class="no-selection">
                        <div class="no-selection-icon"></div>
                        <div class="no-selection-text">Select a widget to edit its properties</div>
                    </div>
                </div>

                <!-- Layers Tab (Advanced mode) -->
                <div id="layers-panel" class="panel-content hidden">
                    <div class="no-selection">
                        <div class="no-selection-icon"></div>
                        <div class="no-selection-text">No widgets on canvas</div>
                    </div>
                </div>
            </aside>
        </div>

        <!-- Status Bar -->
        <footer class="status-bar">
            <div class="status-left">
                <span id="status-message" class="status-message">Ready</span>
            </div>
            <div class="status-right">
                <span id="status-frame">Frame: --</span>
                <span id="status-position"></span>
                <span id="status-size"></span>
            </div>
        </footer>
    </div>

    <!-- Command Modal -->
    <div id="command-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>CLI Command</h3>
                <button class="modal-close" data-close-modal>&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: var(--space-3); color: var(--color-text-secondary);">
                    Run this command in your terminal to render the video:
                </p>
                <pre id="command-output" class="command-output"></pre>
            </div>
            <div class="modal-footer">
                <button id="btn-copy-command" class="btn btn-primary">Copy to Clipboard</button>
            </div>
        </div>
    </div>

    <!-- Scripts: Core state management from editor -->
    <script src="/static/editor/js/state/EditorState.js"></script>
    <script src="/static/editor/js/state/HistoryManager.js"></script>
    <script src="/static/editor/js/api/client.js"></script>
    <script src="/static/editor/js/utils/storage.js"></script>

    <!-- Scripts: Editor components (for Advanced mode) -->
    <script src="/static/editor/js/components/WidgetPalette.js"></script>
    <script src="/static/editor/js/components/Canvas.js"></script>
    <script src="/static/editor/js/components/PropertiesPanel.js"></script>
    <script src="/static/editor/js/components/LayersPanel.js"></script>

    <!-- Scripts: Unified app -->
    <script src="/static/unified/js/state/UnifiedState.js"></script>
    <script src="/static/unified/js/utils/PreviewDebouncer.js"></script>
    <script src="/static/unified/js/services/TemplateService.js"></script>
    <script src="/static/unified/js/components/FileUploader.js"></script>
    <script src="/static/unified/js/components/Timeline.js"></script>
    <script src="/static/unified/js/components/TemplateModal.js"></script>
    <script src="/static/unified/js/components/TemplateList.js"></script>
    <script src="/static/unified/js/components/TemplateManager.js"></script>
    <script src="/static/unified/js/components/ModeToggle.js"></script>
    <script src="/static/unified/js/components/GpxOptionsPanel.js"></script>
    <script src="/static/unified/js/components/RenderModal.js"></script>
    <script src="/static/unified/js/components/BatchRenderModal.js"></script>
    <script src="/static/unified/js/components/Toast.js"></script>
    <script src="/static/unified/js/UnifiedApp.js"></script>
</body>
</html>
